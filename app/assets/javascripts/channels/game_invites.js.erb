//= require cable
//= require application
//= require_self
//= require_tree .

let invitees = [];
let gameInviteId = '';
let userId = '';

function inviteSubscriptionCreator (userId) {
	return App.cable.subscriptions.create({channel: 'GameInvitesChannel', user_id: userId}, {  
		received: function(data) {
			$("#notification-area").html(data.message + "<a href='/games/" + data.game_invite_id + "/join' rel='nofollow' data-method='post' class='btn btn-info left'>Join the game</a>");
		}
	});
}

function bindClickListeners () {
	$('[data-invite]').on("click", function() {
		gameInviteId = location.href.split('/').slice(-1).pop();
		invitees.push(this.dataset.user);
	});

	$('#send-invites').on('click', function() {
		invitees.forEach( function(invitee) {
			App['game_invites_' + invitee] = inviteSubscriptionCreator(invitee);
			// App['game_invites_' + invitee].setUserId(invitee);  
			App['game_invites_' + invitee].send({message: "You have been invited to a new game", game_invite_id: gameInviteId });
			console.log('game_invites_' + invitee);
		});
	});
}

function setUserId(user) {
    this.userId = user;
}

$(document).ready(bindClickListeners);

$(document).on('turbolinks:load', function () {
	// do stuffs
	$.get('/current_user', function(result){
  		userId = result.id;
  		App['game_invites_' + userId] = inviteSubscriptionCreator(userId); 
	});
});