//= require cable
//= require application
//= require_self
//= require_tree .

let arrayOfGames = []; 

function subscriptionCreator (gameId) {
	return App.cable.subscriptions.create({channel: 'WaitingRoomChannel', waiting_room: gameId}, {  
		received: function(data) {
			let gameId = data.game_id;
			let playersCount = parseInt(data.players_count);  
		    
		    if (window.location.href.includes('games/' + gameId)) {
		    	window.location.reload();
		    	$("#notification-area").removeClass('hidden');
		    	$("#notification-area").html(data.message);
		    } else {
		    	$("#notification-area").removeClass('hidden');
		    	$("#notification-area").html(data.message + "<a href='/games/" + gameId +"' class='btn btn-info left'>Go to game</a>");
		    };

		}
	});
}

$(document).on('turbolinks:load', function() {
	$('[data-game]').each( function(index, element) {
		let gameId = element.dataset.game;
		if (!arrayOfGames.includes(gameId)) {
			arrayOfGames.push(gameId);
		}			
	});
	arrayOfGames.forEach( function(game) {
		App["waiting_room_" + game] = subscriptionCreator(game);
	});	
});

